<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Map gardening scatterplots</title>
    <script src="d3/d3.v3.min.js" charset="utf-8"></script>
    <script src="d3/queue.v1.min.js" charset="utf-8"></script>
    <link href="gardening_charts.css" rel="stylesheet" />
  </head>
  <body>
    <h1>OSM user activity over time: nodes edited per month</h1>
    <div id="chart"></div>
    <script src="gardening_lines.js"></script>
    <script type="text/javascript">

      var places = [
        "amsterdam",
        "auckland",
        "bayarea",
        "berlin",
        "boston",
        "buenosaires",
        "cairo",
        "crimea",
        "cyprus",
        "douala",
        "haiti",
        "istanbul",
        "jakarta",
        "jerusalem",
        "london",
        "losangeles",
        "manchester",
        "mexicocity",
        "minsk",
        "montevideo",
        "montreal",
        "moscow",
        "mumbai",
        "nairobi",
        "newyork",
        "quebec",
        "paris",
        "rio",
        "santiago",
        "seattle",
        "seoul",
        "tirana",
        "tokyo",
        "toronto",
        "vancouver",
        "yaounde"
      ];

      var q = queue();

      //places.forEach(function(place) { q.defer(d3.tsv, "userstats/userstats_" + place + ".csv");});
      places.forEach(function(place) {
        q.defer(d3.tsv, "userstats/userstats_" + place + ".csv");
        q.defer(d3.tsv, "userstats/output_userstatsbydate_" + place + "_raster_1000m.tsv");
        q.defer(d3.tsv, "userstats/output_totals_" + place + "_raster_1000m.tsv");
      });

      q.awaitAll(ready);

      function ready(error, datasets) {

        if (error) {

          // Do more here
          console.log("Error loading file");

        } else {

          setX('date')
          setY('nodes-log')

          // Combine all the datasets into two arrays, then pass to timeline function.
          // This is because the userstats_ files have a different format
          userstats = [];
          blankspotstats = [];

          for (var i = 0; i < places.length; i++) {
            // for each row, add the placename. Must be a better way to do this.
            // For the "userstats" files
            datasets[(i*3)].forEach(function(d) {
              d.place = places[i];
              userstats.push(d);
            });

            // For the "output_userstatsbydate" files
            datasets[(i*3)+1].forEach(function(d) {
              d.place = places[i];
              blankspotstats.push(d);
            });
            // For the "output_totals" files
            datasets[(i*3)+2].forEach(function(d) {
              d.user_name = "total";
              d.place = places[i];
              blankspotstats.push(d);
            });
          }

          createTimelines(userstats,blankspotstats);

        }
      }

    </script>
  </body>
</html>
